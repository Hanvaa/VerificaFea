const url = require("url");
const fs = require("fs");

class Dispatcher{
    #servizi = {};
    #header = {};
    #estensioni = {
        "js":"text/javascript",
        "css":"text/css",
        "html":"text/html",
        "json":"application/json"
    };

    constructor(header){
        this.#header = header;
    }

    aggServizio(nomeServizio, func){
        this.#servizi[nomeServizio] = func;
    }

    smista(richiesta, risposta){
        let risorsa = url.parse(richiesta.headers.host+richiesta.url, true).pathname;
        let stato = true;
        let funzione = this.#servizi[risorsa];
        if(funzione)
        //Mando in esecuzione il codice relativo al servizio richiesto
            funzione(richiesta, risposta);
        else if(risorsa.includes(".") || risorsa =="/"){
            this.ritornaRisorsaStatica(risorsa, richiesta, risposta);
        }else
            stato=false;
        return stato;
    }

    ritornaRisorsaStatica(risorsa, richiesta, risposta){
        if(risorsa == "/")
            risorsa = "/index.html";
        try{
            let file = fs.readFileSync("public"+risorsa);
            this.#header["Content-Type"] = this.#estensioni[risorsa.split(".")[1]];
            risposta.writeHead(200, this.#header);
            risposta.write(file);
            risposta.end();
        }catch(ex){
            this.#header["Content-Type"] = "text/plain";
            risposta.writeHead(404, this.#header);
            risposta.write("Risorsa non trovata");
            risposta.end();
        }
    }
}

module.exports = Dispatcher;